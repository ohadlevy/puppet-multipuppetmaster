<%
# number of puppet master processes (two mongrels per CPU)
pm_num=processorcount.to_i*2
# convert memorysize fact to MB
case memorysize
	when /(.*) GB$/
		mem=$1.to_f*1024
	when /(.*) MB$/
		mem=$1.to_f
end

pm_num.times do |i|
-%>

check process puppetmaster_<%= i %> with pidfile /var/run/puppet/puppetmasterd.1814<%= i %>.pid 
   start program  "/usr/bin/pm_control start 1814<%= i %>"
   stop program  "/usr/bin/pm_control stop 1814<%= i %>"
   if failed port 1814<%= i %> type tcp then restart
   if 5 restarts within 5 cycles then timeout
   if totalmem > <%= (mem*0.8).div(pm_num) %> Mb then restart
<%end%>
