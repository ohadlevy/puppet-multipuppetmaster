<% if hostname == puppeteer%>LoadModule ssl_module modules/mod_ssl.so<% end %>
Listen 8140

ProxyRequests Off

<Proxy balancer://<%= fqdn %>>
<% (processorcount.to_i*2).times do |i| -%>
    BalancerMember http://127.0.0.1:1814<%= i %>
<% end %>
</Proxy>

<VirtualHost *:8140>
    SSLEngine on
    SSLCipherSuite          SSLv2:-LOW:-EXPORT:RC4+RSA
    SSLCertificateFile      /var/lib/puppet/ssl/certs/<%= fqdn %>.pem
    SSLCertificateKeyFile   /var/lib/puppet/ssl/private_keys/<%= fqdn %>.pem
    SSLCertificateChainFile /var/lib/puppet/ssl/certs/ca.pem
    SSLCACertificateFile    /var/lib/puppet/ssl/certs/ca.pem
#   SSLCARevocationFile     /var/lib/puppet/ssl/ca/ca_crl.pem
    SSLVerifyClient         optional
    SSLVerifyDepth          3
    SSLOptions              +StdEnvVars

    RequestHeader set X-SSL-Subject %{SSL_CLIENT_S_DN}e
    RequestHeader set X-Client-DN %{SSL_CLIENT_S_DN}e
    RequestHeader set X-Client-Verify %{SSL_CLIENT_VERIFY}e

    <Location />
       SetHandler balancer-manager
       Order allow,deny
       Allow from all
    </Location>

    ProxyPass         / balancer://<%= fqdn %>:8140/
    ProxyPassReverse  / balancer://<%= fqdn %>:8140/
    ProxyPreserveHost on

</VirtualHost>
